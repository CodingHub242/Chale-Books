<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Quote Templates</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="isAdding = true">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Bulk Actions Toolbar -->
  <ion-toolbar *ngIf="selectedTemplates.length > 0" color="warning">
    <ion-buttons slot="start">
      <ion-button (click)="clearSelection()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedTemplates.length }} template(s) selected</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="bulkDelete()" color="danger">
        <ion-icon name="trash" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filters Toolbar -->
  <ion-toolbar *ngIf="!isAdding && selectedTemplates.length === 0" class="filters-toolbar">
    <ion-grid class="filters-grid">
      <ion-row class="filters-row">
        <ion-col size="12" size-md="8">
          <ion-searchbar [(ngModel)]="searchTerm" placeholder="Search templates..." animated class="search-bar" (ionInput)="onSearch($event)"></ion-searchbar>
        </ion-col>
        <ion-col size="12" size-md="4" class="ion-text-end">
          <ion-button fill="clear" (click)="clearFilters()" *ngIf="hasActiveFilters()">
            <ion-icon name="close-circle" slot="start"></ion-icon>
            Clear Filters
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Template Table -->
  <div *ngIf="!isAdding" class="templates-container">
    <div class="table-responsive">
      <table class="templates-table">
        <thead>
          <tr>
            <th class="checkbox-column">
              <ion-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="isSomeSelected()"
                (ionChange)="toggleSelectAll($event)">
              </ion-checkbox>
            </th>
            <th (click)="sortBy('name')" class="sortable">
              Name
              <ion-icon *ngIf="sortField === 'name'" [name]="sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'"></ion-icon>
            </th>
            <th>Currency</th>
            <th>Items Count</th>
            <th (click)="sortBy('total')" class="sortable">
              Total
              <ion-icon *ngIf="sortField === 'total'" [name]="sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'"></ion-icon>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let template of getFilteredTemplates()"
              [class.selected]="isSelected(template)"
              (click)="onRowClick(template, $event)">
            <td class="checkbox-column" (click)="$event.stopPropagation()">
              <ion-checkbox
                [checked]="isSelected(template)"
                (ionChange)="toggleSelect(template, $event)">
              </ion-checkbox>
            </td>
            <td class="clickable" (click)="editTemplate(template)">
              <div class="name-cell">
                <span class="name">{{ template.name }}</span>
              </div>
            </td>
            <td class="clickable" (click)="editTemplate(template)">
              <span class="currency">{{ template.currency?.code }}</span>
            </td>
            <td class="clickable" (click)="editTemplate(template)">
              <span class="items-count">{{ template.items?.length || 0 }} item(s)</span>
            </td>
            <td class="clickable amount-column" (click)="editTemplate(template)">
              <div class="total-info">
                <span class="total">{{ calculateTemplateTotal(template) | number:'1.2-2' }}</span>
                <span class="currency">{{ template.currency?.code }}</span>
              </div>
            </td>
            <td class="actions-column">
              <div class="action-buttons">
                <ion-button fill="clear" size="small" (click)="useTemplate(template); $event.stopPropagation()">
                  <ion-icon name="document" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" (click)="editTemplate(template); $event.stopPropagation()">
                  <ion-icon name="create" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" color="danger" (click)="deleteTemplate(template); $event.stopPropagation()">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </td>
          </tr>
          <tr *ngIf="getFilteredTemplates().length === 0">
            <td colspan="6" class="empty-row">
              <div class="empty-state">
                <ion-icon name="document-outline" class="empty-icon"></ion-icon>
                <h2>No templates found</h2>
                <p>Create your first quote template to speed up quote creation</p>
                <ion-button (click)="isAdding = true">
                  <ion-icon name="add" slot="start"></ion-icon>
                  Create Template
                </ion-button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Template Form -->
  <div *ngIf="isAdding" class="form-container">
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ editingTemplate ? 'Edit Template' : 'Create Template' }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form [formGroup]="templateForm" (ngSubmit)="saveTemplate()">
          <!-- Template Name -->
          <ion-item>
            <ion-label position="floating">Template Name *</ion-label>
            <ion-input formControlName="name" type="text"></ion-input>
          </ion-item>

          <!-- Currency -->
          <ion-item>
            <ion-label>Currency *</ion-label>
            <ion-select formControlName="currency_id" placeholder="Select Currency" >
              <ion-select-option *ngFor="let currency of currencies" [value]="currency.id">
                {{ currency.name }} ({{ currency.code }})
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Items -->
          <div formArrayName="items">
            <h3>Items</h3>
            <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="item-row">
              <ion-grid>
                <ion-row>
                  <ion-col size="12" size-md="4">
                    <ion-item>
                      <ion-label>Select Item (Optional)</ion-label>
                      <ion-select placeholder="Choose from saved items" (ionChange)="selectItem($event.detail.value, i)">
                        <ion-select-option *ngFor="let availableItem of availableItems" [value]="availableItem">
                          {{ availableItem.name }} - {{ availableItem.unit_price | currency:availableItem.user.currency }}
                        </ion-select-option>
                      </ion-select>
                    </ion-item>
                    <ion-item>
                      <ion-label position="floating">Description *</ion-label>
                      <ion-input formControlName="description" type="text"></ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="6" size-md="2">
                    <ion-item>
                      <ion-label position="floating">Qty *</ion-label>
                      <ion-input formControlName="quantity" type="number" min="1"></ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="6" size-md="2">
                    <ion-item>
                      <ion-label position="floating">Unit Price *</ion-label>
                      <ion-input formControlName="unit_price" type="number" min="0" step="0.01"></ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="6" size-md="2">
                    <ion-item>
                      <ion-label position="floating">Tax %</ion-label>
                      <ion-input formControlName="tax_rate" type="number" min="0" max="100" step="0.01"></ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="6" size-md="2">
                    <ion-item>
                      <ion-label position="floating">Discount</ion-label>
                      <ion-input formControlName="discount" type="number" min="0" step="0.01"></ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="12" size-md="auto" class="ion-text-center">
                    <p class="item-total">{{ calculateItemTotal(item.value) | number:'1.2-2' }}</p>
                    <ion-button *ngIf="items.length > 1" fill="clear" color="danger" (click)="removeItem(i)">
                      <ion-icon name="trash"></ion-icon>
                    </ion-button>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </div>

            <ion-button expand="block" fill="outline" (click)="addItem()">
              <ion-icon name="add" slot="start"></ion-icon>
              Add Item
            </ion-button>
          </div>

          <!-- Totals Summary -->
          <ion-card class="totals-card">
            <ion-card-content>
              <ion-grid>
                <ion-row>
                  <ion-col size="6" class="ion-text-end">
                    <strong>Subtotal:</strong>
                  </ion-col>
                  <ion-col size="6" class="ion-text-end">
                    {{ calculateSubtotal() | number:'1.2-2' }}
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="6" class="ion-text-end">
                    <strong>Discount:</strong>
                  </ion-col>
                  <ion-col size="6" class="ion-text-end">
                    -{{ calculateTotalDiscount() | number:'1.2-2' }}
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="6" class="ion-text-end">
                    <strong>Tax:</strong>
                  </ion-col>
                  <ion-col size="6" class="ion-text-end">
                    {{ calculateTotalTax() | number:'1.2-2' }}
                  </ion-col>
                </ion-row>
                <ion-row class="grand-total">
                  <ion-col size="6" class="ion-text-end">
                    <strong>TOTAL:</strong>
                  </ion-col>
                  <ion-col size="6" class="ion-text-end">
                    <strong>{{ calculateGrandTotal() | number:'1.2-2' }}</strong>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>

          <!-- Notes -->
          <ion-item>
            <ion-label position="floating">Notes</ion-label>
            <ion-textarea formControlName="notes" rows="3"></ion-textarea>
          </ion-item>

          <!-- Form Actions -->
          <div class="form-actions">
            <ion-button expand="block" type="submit" [disabled]="!templateForm.valid">
              {{ editingTemplate ? 'Update Template' : 'Create Template' }}
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="editingTemplate ? cancelEdit() : cancelAdd()">
              Cancel
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
